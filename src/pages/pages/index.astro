---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Astro Mini Game">
  <div
    class="flex items-center justify-center min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 px-4"
  >
    <div
      class="w-full max-w-3xl bg-white/5 backdrop-blur-md rounded-2xl shadow-xl p-8 border border-white/10 text-center"
    >
      <h1 class="text-3xl font-bold text-white mb-3">üöÄ Click the Asteroid!</h1>
      <p class="text-lg text-slate-300 mb-4">
        Score points by clicking the moving asteroid before it disappears.
      </p>

      <!-- Game Mode Selection -->
      <div class="flex justify-center gap-3 mb-4" role="radiogroup" aria-label="Game mode selection">
        <button 
          id="modeStatic" 
          role="radio"
          aria-checked="true"
          class="px-4 py-2 rounded-lg bg-indigo-500 text-white font-medium transition-all hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400"
        >
          Static Mode
        </button>
        <button 
          id="modeFalling" 
          role="radio"
          aria-checked="false"
          class="px-4 py-2 rounded-lg bg-slate-600 text-white font-medium transition-all hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-400"
        >
          Falling Mode
        </button>
      </div>

      <canvas
        id="gameCanvas"
        width="700"
        height="500"
        class="rounded-lg shadow-lg border border-slate-600 bg-slate-900/70 touch-none"
        role="img"
        aria-label="Game canvas with moving asteroid"
        tabindex="0"
      ></canvas>

      <p class="mt-6 text-xl text-slate-200">
        Score: <span id="score" class="font-bold text-indigo-400" aria-live="polite">0</span>
      </p>

      <p class="mt-2 text-sm text-slate-400">
        Press Space or click to target the asteroid. Use Tab to navigate.
      </p>

      <div class="mt-8">
        <a
          href="/"
          class="px-6 py-3 text-lg font-medium rounded-xl bg-indigo-500 hover:bg-indigo-600 active:scale-95 shadow-md shadow-indigo-500/30 text-white transition-all"
        >
          ‚Üê Back to Home
        </a>
      </div>

      <footer
        class="mt-10 text-center text-slate-500 text-sm border-t border-slate-700 pt-4"
      >
        <p>
          Created by <a
            href="https://github.com/mhaques"
            target="_blank"
            class="text-indigo-400 hover:underline">mhaques</a>
        </p>
        <p class="mt-1">
          Source code available on <a
            href="https://github.com/mhaques/astrolab"
            target="_blank"
            class="text-indigo-400 hover:underline">GitHub</a>
        </p>
      </footer>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    if (!canvas) throw new Error("gameCanvas not found");
    const ctx = canvas.getContext("2d");
    if (!ctx) throw new Error("2D context not supported");

    const scoreEl = document.getElementById("score");
    const modeStaticBtn = document.getElementById("modeStatic");
    const modeFallingBtn = document.getElementById("modeFalling");
    
    if (!modeStaticBtn || !modeFallingBtn) throw new Error("Mode buttons not found");

    let asteroid = { x: 100, y: 100, size: 40, velocityY: 0, rotation: 0, color: 0, shape: [], moveTimer: 0 };
    let score = 0;
    let gameMode = 'static';
    let animationId = null;
    let particles = [];
    let lastTime = 0;

    // Generate random asteroid shape with variation
    function generateAsteroidShape() {
      const points = [];
      const numPoints = 8 + Math.floor(Math.random() * 4);
      for (let i = 0; i < numPoints; i++) {
        const angle = (Math.PI * 2 * i) / numPoints;
        const variance = 0.7 + Math.random() * 0.6;
        points.push({ angle, variance });
      }
      return points;
    }

    // Random color variation
    function getAsteroidColor() {
      const colors = [
        { start: "#ffaa44", mid: "#ff9933", end: "#ff6633" },
        { start: "#aa88ff", mid: "#8866dd", end: "#6644bb" },
        { start: "#ff6688", mid: "#dd4466", end: "#bb2244" },
        { start: "#88ffaa", mid: "#66dd88", end: "#44bb66" }
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function drawAsteroid() {
      const colorScheme = getAsteroidColor();
      
      // Draw asteroid with gradient and irregular shape
      const gradient = ctx.createRadialGradient(
        asteroid.x, asteroid.y, 0,
        asteroid.x, asteroid.y, asteroid.size
      );
      gradient.addColorStop(0, asteroid.color.start);
      gradient.addColorStop(0.5, asteroid.color.mid);
      gradient.addColorStop(1, asteroid.color.end);
      
      ctx.save();
      ctx.translate(asteroid.x, asteroid.y);
      ctx.rotate(asteroid.rotation);
      
      // Draw irregular shape
      ctx.beginPath();
      asteroid.shape.forEach((point, i) => {
        const x = Math.cos(point.angle) * asteroid.size * point.variance;
        const y = Math.sin(point.angle) * asteroid.size * point.variance;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.closePath();
      
      ctx.fillStyle = gradient;
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // Add some crater details with variation
      ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
      const numCraters = 2 + Math.floor(Math.random() * 2);
      for (let i = 0; i < numCraters; i++) {
        const cx = (Math.random() - 0.5) * asteroid.size * 0.6;
        const cy = (Math.random() - 0.5) * asteroid.size * 0.6;
        const size = 3 + Math.random() * 5;
        ctx.beginPath();
        ctx.arc(cx, cy, size, 0, Math.PI * 2);
        ctx.fill();
      }
      
      ctx.restore();
    }

    function drawParticles() {
      particles = particles.filter(p => p.life > 0);
      
      particles.forEach(p => {
        p.x += p.velocityX;
        p.y += p.velocityY;
        p.life -= 0.02;
        p.velocityY += 0.1; // gravity
        
        ctx.fillStyle = `rgba(255, 170, 68, ${p.life})`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    function createExplosion(x, y) {
      for (let i = 0; i < 20; i++) {
        const angle = (Math.PI * 2 * i) / 20;
        const speed = 2 + Math.random() * 3;
        particles.push({
          x,
          y,
          velocityX: Math.cos(angle) * speed,
          velocityY: Math.sin(angle) * speed,
          life: 1,
          size: 2 + Math.random() * 3
        });
      }
    }

    function moveAsteroid() {
      asteroid.x = Math.random() * (canvas.width - asteroid.size * 2) + asteroid.size;
      asteroid.y = Math.random() * (canvas.height - asteroid.size * 2) + asteroid.size;
      asteroid.velocityY = 0;
      asteroid.rotation = Math.random() * Math.PI * 2;
      asteroid.shape = generateAsteroidShape();
      asteroid.color = getAsteroidColor();
    }

    function spawnFallingAsteroid() {
      asteroid.x = Math.random() * (canvas.width - asteroid.size * 2) + asteroid.size;
      asteroid.y = -asteroid.size;
      asteroid.velocityY = 2 + Math.random() * 2;
      asteroid.rotation = Math.random() * Math.PI * 2;
      asteroid.shape = generateAsteroidShape();
      asteroid.color = getAsteroidColor();
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawAsteroid();
      drawParticles();
    }

    function animateStatic(currentTime) {
      const deltaTime = currentTime - lastTime;
      lastTime = currentTime;
      
      // Update move timer
      asteroid.moveTimer += deltaTime;
      if (asteroid.moveTimer >= 2000) {
        moveAsteroid();
        asteroid.moveTimer = 0;
      }
      
      // Slow rotation
      asteroid.rotation += 0.005;
      
      render();
      animationId = requestAnimationFrame(animateStatic);
    }

    function animateFalling() {
      asteroid.y += asteroid.velocityY;
      asteroid.rotation += 0.02;
      
      // Reset if off screen
      if (asteroid.y > canvas.height + asteroid.size) {
        spawnFallingAsteroid();
      }
      
      render();
      animationId = requestAnimationFrame(animateFalling);
    }

    function setGameMode(mode) {
      gameMode = mode;
      
      // Stop existing animations
      if (animationId) cancelAnimationFrame(animationId);
      
      // Update button styles and ARIA
      if (mode === 'static') {
        modeStaticBtn.className = "px-4 py-2 rounded-lg bg-indigo-500 text-white font-medium transition-all hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400";
        modeStaticBtn.setAttribute('aria-checked', 'true');
        modeFallingBtn.className = "px-4 py-2 rounded-lg bg-slate-600 text-white font-medium transition-all hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-400";
        modeFallingBtn.setAttribute('aria-checked', 'false');
        moveAsteroid();
        asteroid.moveTimer = 0;
        lastTime = performance.now();
        animationId = requestAnimationFrame(animateStatic);
      } else {
        modeFallingBtn.className = "px-4 py-2 rounded-lg bg-indigo-500 text-white font-medium transition-all hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400";
        modeFallingBtn.setAttribute('aria-checked', 'true');
        modeStaticBtn.className = "px-4 py-2 rounded-lg bg-slate-600 text-white font-medium transition-all hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-400";
        modeStaticBtn.setAttribute('aria-checked', 'false');
        spawnFallingAsteroid();
        animateFalling();
      }
    }

    function handleHit() {
      score++;
      if (scoreEl) scoreEl.textContent = String(score);
      
      // Create explosion effect
      createExplosion(asteroid.x, asteroid.y);
      
      // Immediate feedback - respawn with new properties
      setTimeout(() => {
        if (gameMode === 'static') {
          moveAsteroid();
          asteroid.moveTimer = 0;
        } else {
          spawnFallingAsteroid();
        }
      }, 100);
    }

    function checkHit(clickX, clickY) {
      const dist = Math.sqrt(
        (clickX - asteroid.x) ** 2 + (clickY - asteroid.y) ** 2
      );
      return dist < asteroid.size;
    }

    // Mouse/touch click handler
    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;

      if (checkHit(clickX, clickY)) {
        handleHit();
      }
    });

    // Touch support for mobile
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      const clickX = touch.clientX - rect.left;
      const clickY = touch.clientY - rect.top;

      if (checkHit(clickX, clickY)) {
        handleHit();
      }
    });

    // Keyboard accessibility - just shoot at asteroid when space/enter pressed
    canvas.addEventListener("keydown", (e) => {
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        // Auto-hit when using keyboard
        handleHit();
      }
    });

    // Mode button handlers
    modeStaticBtn.addEventListener("click", () => setGameMode('static'));
    modeFallingBtn.addEventListener("click", () => setGameMode('falling'));

    // Keyboard support for mode buttons
    modeStaticBtn.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        setGameMode('static');
      }
    });
    modeFallingBtn.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        setGameMode('falling');
      }
    });

    // Make canvas responsive
    function resizeCanvas() {
      const container = canvas.parentElement;
      if (container) {
        const maxWidth = Math.min(700, container.clientWidth - 32);
        const scale = maxWidth / 700;
        canvas.style.width = maxWidth + 'px';
        canvas.style.height = (500 * scale) + 'px';
      }
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Initialize
    setGameMode('static');
  </script>
</Layout>
